<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Sistema de Premia√ß√£o</title>

<style>
body{
    font-family: Arial;
    background:#f2f2f2;
}

.card{
    background:white;
    width:90%;
    max-width:800px;
    margin:40px auto;
    padding:25px;
    border-radius:10px;
    box-shadow:0 2px 10px rgba(0,0,0,0.1);
}

input, select{
    padding:8px;
    margin:5px 0;
    width:100%;
}

button{
    background:#f4b400;
    border:none;
    padding:10px 20px;
    cursor:pointer;
    margin-top:10px;
}
hr{
    margin:25px 0;
}
h2{
    margin-bottom:5px;
}
</style>
</head>

<body>

<div class="card" id="login">
    <h2>Login</h2>
    <input type="text" id="matricula" placeholder="Matr√≠cula">
    <button onclick="login()">Entrar</button>
</div>

<div class="card" id="painel" style="display:none;">
    <h2 id="nomeUsuario"></h2>
    <h3>Pontos: <span id="pontosUsuario"></span></h3>

    <hr>

    <h2>üèÜ Pr√™mios Dispon√≠veis</h2>
    <ul id="listaPremios"></ul>

    <hr>

    <h2>üìú Hist√≥rico de Pontos</h2>
    <input type="date" id="filtroDataHist">
    <input type="text" id="filtroDescHist" placeholder="Filtrar por descri√ß√£o">
    <button onclick="filtrarHistorico()">Filtrar</button>
    <ul id="listaHistorico"></ul>

    <hr>

    <h2>üéÅ Hist√≥rico de Resgates</h2>
    <input type="date" id="filtroDataRes">
    <input type="text" id="filtroPremioRes" placeholder="Filtrar por pr√™mio">
    <button onclick="filtrarResgates()">Filtrar</button>
    <ul id="listaResgates"></ul>

    <hr>

    <button onclick="logout()">Sair</button>
</div>

<script>

const URL_USUARIOS = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR3Qg8_1tUf-yYSyOGNHCH7f6S8rZ1zbB6CST2oM0QgaFdUX5kCD25mdtKSo4nAeOgHXWgO_Qd-UipH/pub?gid=0&single=true&output=csv";
const URL_HISTORICO = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR3Qg8_1tUf-yYSyOGNHCH7f6S8rZ1zbB6CST2oM0QgaFdUX5kCD25mdtKSo4nAeOgHXWgO_Qd-UipH/pub?gid=1676923497&single=true&output=csv";
const URL_RESGATES = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR3Qg8_1tUf-yYSyOGNHCH7f6S8rZ1zbB6CST2oM0QgaFdUX5kCD25mdtKSo4nAeOgHXWgO_Qd-UipH/pub?gid=1374780260&single=true&output=csv";
const URL_PREMIOS = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR3Qg8_1tUf-yYSyOGNHCH7f6S8rZ1zbB6CST2oM0QgaFdUX5kCD25mdtKSo4nAeOgHXWgO_Qd-UipH/pub?gid=1841725743&single=true&output=csv";

let usuarioAtual = null;
let historicoGlobal = [];
let resgatesGlobal = [];

function csvToJson(text){
    const linhas = text.split("\n");
    const cabecalho = linhas[0].split(",");
    return linhas.slice(1).map(linha=>{
        const dados = linha.split(",");
        let obj = {};
        cabecalho.forEach((col,i)=>{
            obj[col.trim()] = dados[i]?.trim();
        });
        return obj;
    });
}

async function login(){
    const mat = document.getElementById("matricula").value.trim();
    const res = await fetch(URL_USUARIOS);
    const data = csvToJson(await res.text());

    const user = data.find(u => u.Matricula == mat);

    if(!user){
        alert("Matr√≠cula n√£o encontrada");
        return;
    }

    usuarioAtual = user;

    document.getElementById("login").style.display="none";
    document.getElementById("painel").style.display="block";

    document.getElementById("nomeUsuario").innerText = user.nome || user.Nome;
    document.getElementById("pontosUsuario").innerText = user.Pontos;

    carregarPremios();
    carregarHistorico();
    carregarResgates();
}

async function carregarPremios(){
    const res = await fetch(URL_PREMIOS);
    const data = csvToJson(await res.text());
    const lista = document.getElementById("listaPremios");
    lista.innerHTML="";

    data.filter(p=>p.Ativo=="SIM")
        .forEach(p=>{
            lista.innerHTML+=`<li>${p["Nome Premio"]} - ${p["Pontos Necessarios"]} pts</li>`;
        });
}

async function carregarHistorico(){
    const res = await fetch(URL_HISTORICO);
    const data = csvToJson(await res.text());

    historicoGlobal = data.filter(h=>h.Matricula==usuarioAtual.Matricula);
    renderHistorico(historicoGlobal);
}

function renderHistorico(lista){
    const ul = document.getElementById("listaHistorico");
    ul.innerHTML="";
    lista.forEach(h=>{
        ul.innerHTML+=`<li>${h.ID} - ${h.Data} - ${h.Descri√ß√£o} (${h.Pontos} pts)</li>`;
    });
}

function filtrarHistorico(){
    const dataFiltro = document.getElementById("filtroDataHist").value;
    const descFiltro = document.getElementById("filtroDescHist").value.toLowerCase();

    let filtrado = historicoGlobal.filter(h=>{
        const okData = dataFiltro ? h.Data==dataFiltro : true;
        const okDesc = descFiltro ? h.Descri√ß√£o.toLowerCase().includes(descFiltro) : true;
        return okData && okDesc;
    });

    renderHistorico(filtrado);
}

async function carregarResgates(){
    const res = await fetch(URL_RESGATES);
    const data = csvToJson(await res.text());

    resgatesGlobal = data.filter(r=>r.Matricula==usuarioAtual.Matricula);
    renderResgates(resgatesGlobal);
}

function renderResgates(lista){
    const ul = document.getElementById("listaResgates");
    ul.innerHTML="";
    lista.forEach(r=>{
        ul.innerHTML+=`<li>${r.Data} - ${r.Premio} (${r.Pontos} pts)</li>`;
    });
}

function filtrarResgates(){
    const dataFiltro = document.getElementById("filtroDataRes").value;
    const premioFiltro = document.getElementById("filtroPremioRes").value.toLowerCase();

    let filtrado = resgatesGlobal.filter(r=>{
        const okData = dataFiltro ? r.Data==dataFiltro : true;
        const okPremio = premioFiltro ? r.Premio.toLowerCase().includes(premioFiltro) : true;
        return okData && okPremio;
    });

    renderResgates(filtrado);
}

function logout(){
    location.reload();
}

</script>

</body>
</html>
